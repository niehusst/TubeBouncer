{"version":3,"file":"bundle.js","sources":["../src/store.js","../src/ext.js","../src/main.js"],"sourcesContent":["/* DATA STORAGE EXPLANATION:\n *\n * 3 separate data bits stored in local storage.\n * DATE_STORAGE_KEY is a map from urlKey to a date string of the\n * last day the urlKey was visited.\n *\n * START_TIME_STORAGE_KEY is a map from urlKey to a list of\n * watch-session start times as unix timestamps.\n * Ordered in chronological order. Corresponds to and end time\n * by matching index; together the 2 values form a time diff pair\n * representing the length of the watch-session.\n *\n * END_TIME_STORAGE_KEY is a map from urlKey to a list of\n * watch-session end times as unix timestamps.\n * Ordered in chronological order. Latest end timestamp will\n * be updated in place repeated until watch-session stagnates.\n * MUST BE SAME LENGTH AS LISTS IN START_TIME_STORAGE_KEY\n */\n\n// TODO: just consolidate this shit into 1 object\n\n// date_key: {urlKey: <date>, ...}\nexport const DATE_STORAGE_KEY = \"date_key\";\nexport const START_TIME_STORAGE_KEY = \"start_key\"; \nexport const END_TIME_STORAGE_KEY = \"end_key\";\nexport const MAX_WATCH_TIME_MS = 1000 * 60 * 60; // 1h\nexport const USER_URLS_KEY = 'user_urls';\n\nexport async function readValue(key, browser) {\n  const savedValue = await browser.storage.local.get(key);\n  return savedValue[key];\n}\n\nexport async function writeValue(key, value, browser) {\n  await browser.storage.local.set({\n    [key]: value,\n  });\n}\n\nexport async function latestStartTime(urlKey, browser) {\n  const startTimeList = await readValue(START_TIME_STORAGE_KEY, browser);\n  if (startTimeList && startTimeList[urlKey]) {\n    return startTimeList[urlKey][startTimeList[urlKey].length - 1];\n  }\n  return undefined;\n}\n\nexport async function latestEndTime(urlKey, browser) {\n  const endTimeList = await readValue(END_TIME_STORAGE_KEY, browser);\n  if (endTimeList && endTimeList[urlKey]) {\n    return endTimeList[urlKey][endTimeList[urlKey].length - 1];\n  }\n  return undefined;\n}\n\nexport async function sumWatchTime(urlKey, browser) {\n  const startTimeMap = (await readValue(START_TIME_STORAGE_KEY, browser)) ?? {};\n  const startTimeList = startTimeMap[urlKey] ?? [];\n  const endTimeMap = (await readValue(END_TIME_STORAGE_KEY, browser)) ?? {};\n  const endTimeList = endTimeMap[urlKey] ?? [];\n\n  if (startTimeList.length !== endTimeList.length) {\n    console.error('watch list len mismatch');\n    return 0;\n  }\n  let sum = 0;\n  for (let i = 0; i < startTimeList.length; i++) {\n    sum += endTimeList[i] - startTimeList[i];\n  }\n  return sum;\n}\n\nexport function getCurrentDate() {\n  const d = new Date();\n  return `${d.getMonth()+1}-${d.getDate()}-${d.getFullYear()}`;\n}\n","import {\n  DATE_STORAGE_KEY,\n  END_TIME_STORAGE_KEY,\n  START_TIME_STORAGE_KEY,\n  latestEndTime,\n  sumWatchTime,\n  MAX_WATCH_TIME_MS,\n  readValue,\n  writeValue,\n  getCurrentDate,\n  USER_URLS_KEY\n} from './store.js';\n\nexport const intervalTime = 5 * 1000; // 5s\n\nexport function navigateAway(window) {\n  window.location.href = \"https://en.wikipedia.org/wiki/Stop_sign#/media/File:Vienna_Convention_road_sign_B2a.svg\";\n}\n\nexport function getUrlKey(window) {\n  return new URL(window.location.href).host;\n}\n\nexport async function didWatchUrlToday(urlKey, browser) {\n  const today = getCurrentDate();\n  const savedDate = (await readValue(DATE_STORAGE_KEY, browser)) ?? {};\n  return savedDate[urlKey] === today;\n}\n\n/**\n * Always appends a new entry to the START/END_TIME_STORAGE_KEY\n * list.\n */\nexport async function writeNewTimeValue(key, urlKey, value, browser) {\n  const timeMap = (await readValue(key, browser)) ?? {};\n\n  if (timeMap[urlKey]) {\n    timeMap[urlKey].push(value);\n  } else {\n    timeMap[urlKey] = [value];\n  }\n\n  await writeValue(key, timeMap, browser);\n}\n\n/**\n * Updates the latest (last) entry of the START/END_TIME_STORAGE_KEY\n * in-place with a new value.\n *\n * key: START/END_TIME_STORAGE_KEY\n * urlKey: urlKey to update value for\n * value: new value to set in key->urlKey->value map\n * browser: ext js browser global\n */\nexport async function updateTimeValue(key, urlKey, value, browser) {\n  const timeMap = (await readValue(key, browser)) ?? {};\n\n  if (timeMap[urlKey]) {\n    timeMap[urlKey][timeMap[urlKey].length - 1] = value;\n  } else {\n    timeMap[urlKey] = [value];\n  }\n\n  await writeValue(key, timeMap, browser);\n}\n\nexport async function updateStoredData(urlKey, browser) {\n  const now = Date.now();\n\n  // reset storage if first time on url today\n  if (!(await didWatchUrlToday(urlKey, browser))) {\n    const today = getCurrentDate();\n    // reset all storage values for urlKey\n    const dates = (await readValue(DATE_STORAGE_KEY, browser)) || {};\n    dates[urlKey] = today;\n    await writeValue(DATE_STORAGE_KEY, dates, browser);\n\n    const startTimes = (await readValue(START_TIME_STORAGE_KEY, browser)) || {};;\n    startTimes[urlKey] = [now];\n    await writeValue(START_TIME_STORAGE_KEY, startTimes, browser);\n    \n    const endTimes = (await readValue(END_TIME_STORAGE_KEY, browser)) || {};;\n    endTimes[urlKey] = [now];\n    await writeValue(END_TIME_STORAGE_KEY, endTimes, browser);\n  }\n\n  // add new time diff pair to lists if we've been off url for a bit\n  // aka start a new watch session\n  const endTime = (await latestEndTime(urlKey, browser)) ?? now;\n  if (now - endTime > 2 * intervalTime) {\n    // add new slots to lists\n    await writeNewTimeValue(START_TIME_STORAGE_KEY, urlKey, now, browser);\n    await writeNewTimeValue(END_TIME_STORAGE_KEY, urlKey, now, browser);\n  } else {\n    // extend current watch session\n    await updateTimeValue(END_TIME_STORAGE_KEY, urlKey, now, browser);\n  }\n}\n\n/**\n * Returns `true` if a window with a location matching\n * urlKey has been focused for MAX_WATCH_TIME_MS or more during\n * this day. Else `false`.\n */\nexport async function spentTooLongOnUrl(urlKey, browser) {\n  const tubeWatched = await sumWatchTime(urlKey, browser);\n  return tubeWatched >= MAX_WATCH_TIME_MS;\n}\n\n/**\n * main logic body. intended to be run on an interval\n */\nexport async function main({browser, window}) {\n  const urlKey = getUrlKey(window);\n  // Only decrease timer if current site matches user regex patterns\n  const userPatterns = await readValue(USER_URLS_KEY ,browser) || [];\n  const matches = userPatterns.some(pattern => {\n    try {\n      return new RegExp(pattern).test(urlKey);\n    } catch {\n      // Invalid regex, ignore\n      return false;\n    }\n  });\n\n  if (matches) {\n    await updateStoredData(urlKey, browser);\n    if (await spentTooLongOnUrl(urlKey, browser)) {\n      navigateAway(window);\n    }\n  }\n}\n","import { END_TIME_STORAGE_KEY, START_TIME_STORAGE_KEY, DATE_STORAGE_KEY, readValue } from './store.js';\nimport { intervalTime, main } from './ext.js';\n\n/* eslint-disable no-unused-vars */\nasync function printState() {\n  const endTimeList = await readValue(END_TIME_STORAGE_KEY, browser);\n  const startTimeList = await readValue(START_TIME_STORAGE_KEY, browser);\n  const dates = await readValue(DATE_STORAGE_KEY, browser);\n  console.log('start: ', startTimeList); \n  console.log('end: ', endTimeList); \n  console.log('dates: ', dates);\n}\n\nsetInterval(() => {\n  main({browser, window});\n}, intervalTime);\n\n"],"names":[],"mappings":"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"}